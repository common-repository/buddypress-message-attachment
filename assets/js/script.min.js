window.BPMsgAt_Media_Uploader=function(l,s){let t=!1,r=s.uploader||{},n=s.lang,e=s.selectors,d={},u={init:function(){u.setup(),l(document).on("click","#member-secondary-nav li a",function(t){s.current_action=l(this).parent().data("bp-user-scope"),u.setup()}),l.ajaxPrefilter(this.prefilter)},setup:function(){if(d={},!u.get_elements())return!1;setTimeout(function(){u.start_uploader()},20)},get_elements:function(){return"compose"==s.current_action?d.$form=l(e.form_message):d.$form=l(e.form_reply),0!==d.$form.length&&(d.$button=d.$form.find('input[type="submit"],button[type="submit"],#bp-messages-send'),d.$field_attachment_ids=d.$form.find('input[name="bp_msgat_attachment_ids"]'),d.$upload_button=l("#btn_msgat_upload"),!0)},get_query_variable:function(t,e){if(void 0===t||""==t||void 0===e||""==e)return"";for(var a=t.split("&"),o=0;o<a.length;o++){var r=a[o].split("=");if(r[0]==e)return r[1]}return!1},prefilter:function(t,e,a){var o,r,n=u.get_query_variable(t.data,"action");if(void 0!==n)switch(n){case"messages_send_reply":s.current_action="thread";var i=l.extend({},e.data,{bp_msgat_attachment_ids:d.$field_attachment_ids.val()});t.data=l.param(i),t.success=(r=t.success,d.$field_attachment_ids.val(""),l(".msgat-uploaded-file").remove(),function(t,e,a){l.isFunction(r)&&r(t,e,a)});break;case"messages_get_thread_messages":s.current_action="thread",t.success=(o=t.success,function(t,e,a){l.isFunction(o)&&o(t,e,a),u.setup()})}},start_uploader:function(){console.log("inside start_uploader"),t&&t.destroy(),t=new plupload.Uploader({runtimes:"html5,silverlight,flash,html4",browse_button:"btn_msgat_upload",dragdrop:!1,max_file_size:r.max_file_size||"5mb",multi_selection:r.multiselect||!1,url:ajaxurl,multipart:!0,multipart_params:{action:"bp_msgat_upload",cookie:encodeURIComponent(document.cookie),_wpnonce:r.nonce},flash_swf_url:r.swf_url||"",silverlight_xap_url:r.silverlight_xap_url||"",filters:r.filters,init:{FilesAdded:function(t,e){d.$button.attr("disabled","disabled").addClass("loading");var a=d.$upload_button.html();d.$upload_button.attr("disabled","disabled").addClass("loading").data("org_text",a).html(n.uploading),t.start()},FileUploaded:function(t,e,a){d.$button.removeAttr("disabled").removeClass("loading"),d.$upload_button.removeAttr("disabled").removeClass("loading").html(d.$upload_button.data("org_text"));var o=l.parseJSON(a.response);o.status?r.multiselect||(attachment_ids=o.attachment_id,d.$field_attachment_ids.val(attachment_ids),l(".msgat-uploaded-file").remove(),a="<span class='msgat-uploaded-file'>"+o.name+"<a href='#' data-attachment_id='"+o.attachment_id+"' class='remove-uploaded-file'  onclick='return window.BPMsgAt_Media_Uploader.removeAttachment(this)'  title='"+n.remove+"'>x</a></span>",l("#btn_msgat_upload").after(a)):(d.$field_attachment_ids.val(""),l(".msgat-uploaded-file").remove(),alert(o.message))},Error:function(t,e){d.$button.removeAttr("disabled").removeClass("loading"),d.$upload_button.removeAttr("disabled").removeClass("loading").html(d.$upload_button.data("org_text")),u.show_upload_error(e.code),t.refresh(),r.multiselect||d.$field_attachment_ids.val("")}}}),t.init()},show_upload_error:function(t){switch(t){case plupload.FILE_EXTENSION_ERROR:alert(n.upload_error.file_type);break;case plupload.FILE_SIZE_ERROR:alert(n.upload_error.file_size);break;default:alert(n.upload_error.generic)}},removeAttachment:function(t){return $el=l(t),d.$field_attachment_ids.val(""),$el.closest(".msgat-uploaded-file").remove(),!1}};var a={setup:function(){u.init()},removeAttachment:function(t){return u.removeAttachment(t)}};return l(document).ready(function(){u.init()}),a}(window.jQuery,window.BPMsgAt_Util);